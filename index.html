<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>AR Marker Detection</title>
    <script src="https://cdn.jsdelivr.net/npm/three@0.132.2/build/three.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/three.js/build/ar-threex.js"></script>
    <style>
        body { 
            margin: 0;
            overflow: hidden;
            font-family: Arial;
        }
        #status {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 10px;
            border-radius: 5px;
            z-index: 100;
        }
        #marker-detected {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,255,0,0.7);
            color: white;
            padding: 15px;
            border-radius: 5px;
            font-size: 1.5em;
            display: none;
            z-index: 100;
        }
    </style>
</head>
<body>
    <div id="status">Stato: In attesa della webcam...</div>
    <div id="marker-detected">Marker Hiro Rilevato!</div>

    <script>
        // Elementi UI
        const statusDiv = document.getElementById('status');
        const markerDetectedDiv = document.getElementById('marker-detected');

        // 1. Setup Three.js
        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(60, window.innerWidth/window.innerHeight, 0.1, 100);
        const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.body.appendChild(renderer.domElement);

        // 2. Configurazione AR.js
        const arToolkitSource = new THREEx.ArToolkitSource({
            sourceType: 'webcam',
            sourceWidth: 1280,
            sourceHeight: 720,
            displayWidth: window.innerWidth,
            displayHeight: window.innerHeight
        });

        const arToolkitContext = new THREEx.ArToolkitContext({
            cameraParametersUrl: 'https://raw.githubusercontent.com/AR-js-org/AR.js/master/three.js/data/camera_para.dat',
            detectionMode: 'mono_and_matrix',
            matrixCodeType: '3x3',
            maxDetectionRate: 60
        });

        // 3. Marker Hiro
        const markerRoot = new THREE.Group();
        scene.add(markerRoot);
        
        // Variabile per tracciare lo stato del marker
        let isMarkerDetected = false;
        let detectionTimeout;

        // 4. Avvio applicazione
        arToolkitSource.init(() => {
            statusDiv.textContent = "Webcam attiva - Cerca il marker Hiro";
            
            arToolkitContext.init(() => {
                camera.projectionMatrix.copy(arToolkitContext.getProjectionMatrix());
                
                // Controllo marker
                const markerControls = new THREEx.ArMarkerControls(arToolkitContext, markerRoot, {
                    type: 'pattern',
                    patternUrl: 'https://raw.githubusercontent.com/AR-js-org/AR.js/master/data/data/patt.hiro',
                    changeMatrixMode: 'cameraTransformMatrix'
                });

                // Oggetto 3D da visualizzare
                const geometry = new THREE.BoxGeometry(0.5, 0.5, 0.5);
                const material = new THREE.MeshNormalMaterial();
                const cube = new THREE.Mesh(geometry, material);
                cube.position.y = 0.5;
                markerRoot.add(cube);

                // Animazione e controllo del marker
                function animate() {
                    requestAnimationFrame(animate);
                    
                    // Controlla se il marker è visibile
                    const markerVisible = markerRoot.visible;
                    
                    if (markerVisible && !isMarkerDetected) {
                        // Marker appena rilevato
                        isMarkerDetected = true;
                        markerDetectedDiv.style.display = 'block';
                        statusDiv.textContent = "Marker Hiro rilevato!";
                        
                        // Nascondi il messaggio dopo 3 secondi
                        clearTimeout(detectionTimeout);
                        detectionTimeout = setTimeout(() => {
                            markerDetectedDiv.style.display = 'none';
                        }, 3000);
                    } 
                    else if (!markerVisible && isMarkerDetected) {
                        // Marker perso
                        isMarkerDetected = false;
                        statusDiv.textContent = "Marker perso - Cerca il marker Hiro";
                    }
                    
                    // Animazione
                    if (markerVisible) {
                        cube.rotation.x += 0.01;
                        cube.rotation.y += 0.01;
                    }
                    
                    if (arToolkitSource.ready) {
                        arToolkitContext.update(arToolkitSource.domElement);
                    }
                    renderer.render(scene, camera);
                }
                animate();
            });
        });

        // Gestione errori
        arToolkitSource.init().catch(error => {
            statusDiv.textContent = `ERRORE: ${error.message}`;
            if (error.name === 'NotAllowedError') {
                statusDiv.innerHTML += "<br>→ Abilita i permessi della webcam";
            }
        });

        // Adatta alle dimensioni della finestra
        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });
    </script>
</body>
</html>
