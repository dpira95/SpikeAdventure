<!DOCTYPE html>
<html>
<head>
  <title>AR.js con Rettangolo Spostabile</title>
  <!-- Libreria A-Frame -->
  <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
  <!-- Libreria AR.js -->
  <script src="https://raw.githack.com/AR-js-org/AR.js/3.4.5/aframe/build/aframe-ar.js"></script>

  <style>
    .message {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      padding: 12px 18px;
      background-color: rgba(0,0,0,0.5);
      color: white;
      font-family: Arial, sans-serif;
      border-radius: 10px;
      z-index: 9999;
      user-select: none;
    }
  </style>
</head>

<body style="margin: 0; overflow: hidden;">
  <div id="info" class="message">Inquadra il marker...</div>

  <a-scene embedded arjs>
    <!-- Marker Hiro -->
    <a-marker preset="hiro" id="hiroMarker"></a-marker>

    <!-- Rettangolo indipendente ancorato alla telecamera -->
    <a-plane 
      id="draggableRect" 
      position="0 0 -2"
      rotation="-45 0 0" 
      width="1" height="3" 
      color="#7BC8A4"
      visible="false"
      cursor-listener>
    </a-plane>

    <!-- Camera -->
    <a-entity camera look-controls>
      <a-entity cursor="fuse: false; rayOrigin: mouse;"></a-entity>
    </a-entity>
  </a-scene>

  <script>
    const marker = document.querySelector("#hiroMarker");
    const info = document.getElementById("info");
    const rect = document.querySelector("#draggableRect");
    let isDragging = false;

    marker.addEventListener("markerFound", () => {
      info.innerText = "Marker rilevato!";
      rect.setAttribute("visible", "true");
    });

    marker.addEventListener("markerLost", () => {
      info.innerText = "Marker perso, puoi spostare il rettangolo.";
    });

    // Gestisci il trascinamento
    rect.addEventListener('mousedown', () => { isDragging = true; });
    window.addEventListener('mouseup', () => { isDragging = false; });
    
    window.addEventListener('mousemove', (e) => {
      if (!isDragging) return;

      // Normalizza le coordinate del mouse
      let sceneEl = document.querySelector('a-scene');
      let camera = sceneEl.camera;
      let rectPos = rect.object3D.position;

      let movementX = e.movementX / 200;
      let movementY = e.movementY / 200;

      rectPos.x += movementX;
      rectPos.y -= movementY; // Invertito per un movimento naturale
    });

    // Supporto touch mobile
    window.addEventListener('touchmove', (e) => {
      e.preventDefault();
      let touch = e.touches[0];

      let movementX = touch.clientX - window.innerWidth / 2;
      let movementY = touch.clientY - window.innerHeight / 2;

      rect.object3D.position.x = movementX / 300;
      rect.object3D.position.y = -movementY / 300;
    }, { passive: false });
  </script>
</body>
</html>
