<!DOCTYPE html>
<html>
<head>
  <title>AR.js - Menu Completo con Dettagli Piatti</title>
  <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
  <script src="https://raw.githack.com/AR-js-org/AR.js/3.4.5/aframe/build/aframe-ar.js"></script>

  <style>
    .message {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      padding: 12px 18px;
      background-color: rgba(0,0,0,0.6);
      color: white;
      font-family: Arial, sans-serif;
      border-radius: 10px;
      z-index: 9999;
      user-select: none;
    }
  </style>
</head>

<body style="margin: 0; overflow: hidden;">
  <div id="info" class="message">Inquadra il marker...</div>

  <a-scene embedded arjs>
    <a-marker preset="hiro" id="hiroMarker"></a-marker>

    <!-- MENU PRINCIPALE -->
    <a-plane id="menuPanel"
      position="0 0 -2"
      rotation="-45 0 0"
      width="1" height="1.5"
      color="#222"
      opacity="0.8"
      visible="false">

      <a-text value="Menu" color="#FFFFFF"
              position="0 0.65 0.01" align="center" width="1.2"></a-text>

      <!-- MASCHERA menu (per effetto sfumatura) -->
      <a-plane width="1" height="1.2" position="0 0 0.005" material="shader:flat; transparent:true; opacity:0.9; color:#222"></a-plane>

      <!-- Scroll Container con pulsanti piatti -->
      <a-entity id="buttonContainer" position="0 0 0.01">
        <!-- Pulsanti -->
        <a-plane class="menu-button" data-info="Piatto 1:Ingredienti freschi" color="#FF4444" width="0.9" height="0.2" position="0 0.5 0.01">
          <a-text value="Pizza Margherita" align="left" width="0.8" color="#FFF" position="-0.4 0 0.02"></a-text>
          <a-text value="6,50 €" align="right" width="0.8" color="#FFF" position="0.4 0 0.02"></a-text>
        </a-plane>

        <a-plane class="menu-button" data-info="Piatto 2:Saporito e gustoso" color="#44AAFF" width="0.9" height="0.2" position="0 0.2 0.01">
          <a-text value="Lasagna" align="left" width="0.8" color="#FFF" position="-0.4 0 0.02"></a-text>
          <a-text value="8,00 €" align="right" width="0.8" color="#FFF" position="0.4 0 0.02"></a-text>
        </a-plane>

        <a-plane class="menu-button" data-info="Piatto 3:Con ingredienti bio" color="#44FF88" width="0.9" height="0.2" position="0 -0.1 0.01">
          <a-text value="Insalata Greca" align="left" width="0.8" color="#FFF" position="-0.4 0 0.02"></a-text>
          <a-text value="7,00 €" align="right" width="0.8" color="#FFF" position="0.4 0 0.02"></a-text>
        </a-plane>

        <a-plane class="menu-button" data-info="Piatto 4:Tradizione romana" color="#FFAA44" width="0.9" height="0.2" position="0 -0.4 0.01">
          <a-text value="Carbonara" align="left" width="0.8" color="#FFF" position="-0.4 0 0.02"></a-text>
          <a-text value="9,50 €" align="right" width="0.8" color="#FFF" position="0.4 0 0.02"></a-text>
        </a-plane>

        <a-plane class="menu-button" data-info="Piatto 5:Dolce e cremoso" color="#AA44FF" width="0.9" height="0.2" position="0 -0.7 0.01">
          <a-text value="Tiramisù" align="left" width="0.8" color="#FFF" position="-0.4 0 0.02"></a-text>
          <a-text value="5,00 €" align="right" width="0.8" color="#FFF" position="0.4 0 0.02"></a-text>
        </a-plane>

        <a-plane class="menu-button" data-info="Piatto 6:Specialità chef" color="#FF4488" width="0.9" height="0.2" position="0 -1 0.01">
          <a-text value="Filetto al pepe" align="left" width="0.8" color="#FFF" position="-0.4 0 0.02"></a-text>
          <a-text value="12,00 €" align="right" width="0.8" color="#FFF" position="0.4 0 0.02"></a-text>
        </a-plane>
      </a-entity>
    </a-plane>

    <!-- PANEL DETTAGLI PIATTO -->
    <a-plane id="detailPanel" position="0 0 -1.8" rotation="-45 0 0" width="1" height="0.8" color="#333" opacity="0.9" visible="false">
      <a-text id="detailText" value="" color="#FFF" position="0 0.15 0.01" align="center" width="0.9"></a-text>
      <a-plane id="closeBtn" color="#990000" width="0.4" height="0.15" position="0 -0.25 0.01">
        <a-text value="Chiudi" align="center" color="#FFF" width="0.8" position="0 0 0.02"></a-text>
      </a-plane>
    </a-plane>

    <!-- Cursore personalizzato -->
    <a-entity id="customCursor"
              geometry="primitive: circle; radius: 0.02"
              material="color: yellow; shader: flat"
              position="0 0 -1"
              visible="false">
    </a-entity>

    <!-- Camera -->
    <a-entity camera look-controls>
      <a-cursor id="cursor"
                rayOrigin="mouse"
                fuse="false"
                material="opacity: 0;"
                position="0 0 -1">
      </a-cursor>
    </a-entity>
  </a-scene>

<script>
const marker = document.querySelector("#hiroMarker");
const info = document.getElementById("info");
const menuPanel = document.querySelector("#menuPanel");
const detailPanel = document.querySelector("#detailPanel");
const detailText = document.querySelector("#detailText");
const closeBtn = document.querySelector("#closeBtn");
const buttonContainer = document.querySelector("#buttonContainer");
const buttons = document.querySelectorAll('.menu-button');
const customCursor = document.querySelector("#customCursor");

// Variabili per gestire scroll e trascinamento
let isMarkerFound = false, isDraggingPanel = false;
let startPressTimer, longPressActive = false;
let prevPosition = { x: 0, y: 0 };

// Rilevamento marker
marker.addEventListener("markerFound", () => {
  isMarkerFound = true;
  info.innerText = "Marker trovato!";
  menuPanel.setAttribute("visible", "true");
  customCursor.setAttribute("visible", "true");
});

marker.addEventListener("markerLost", () => {
  info.innerText = "Marker perso, puoi interagire col menu.";
  customCursor.setAttribute("visible", "false");
});

// Aggiorna la posizione del cursore personalizzato in base al touch
window.addEventListener('touchstart', e => {
  const touch = e.touches[0];
  updateCursorPosition(touch);
});

window.addEventListener('touchmove', e => {
  const touch = e.touches[0];
  updateCursorPosition(touch);
});

// Simula la selezione al rilascio del tocco
window.addEventListener('touchend', () => {
  const cursorPosition = customCursor.object3D.position;
  const camera = document.querySelector("[camera]").object3D;
  const raycaster = new THREE.Raycaster();
  raycaster.setFromCamera(new THREE.Vector2(cursorPosition.x, cursorPosition.y), camera);

  const intersects = raycaster.intersectObjects(buttonContainer.object3D.children, true);

  if (intersects.length > 0) {
    const intersectedEl = intersects[0].object.el;
    if (intersectedEl.classList.contains('menu-button')) {
      const dish = intersectedEl.querySelector('a-text').getAttribute('value');
      const desc = intersectedEl.getAttribute('data-info');
      detailText.setAttribute('value', dish + "\n" + desc);
      menuPanel.setAttribute('visible', false);
      detailPanel.setAttribute('visible', true);
    }
  }
});

// Funzione per aggiornare la posizione del cursore personalizzato
function updateCursorPosition(touch) {
  const x = (touch.clientX / window.innerWidth) * 2 - 1;
  const y = -(touch.clientY / window.innerHeight) * 2 + 1;
  customCursor.object3D.position.set(x, y, -1);
}

// Gestione long-press per trascinare il pannello
menuPanel.addEventListener('touchstart', (e) => {
  startPressTimer = setTimeout(() => {
    longPressActive = true;
  }, 500); // Attiva il trascinamento dopo 500ms
  prevPosition = { x: e.touches[0].clientX, y: e.touches[0].clientY };
});

menuPanel.addEventListener('touchend', () => {
  clearTimeout(startPressTimer);
  longPressActive = false;
});

// Movimento pannello o scroll
window.addEventListener('touchmove', (e) => {
  if (!isMarkerFound) return;

  let deltaX = (e.touches[0].clientX - prevPosition.x) / 200;
  let deltaY = (e.touches[0].clientY - prevPosition.y) / 200;

  if (longPressActive) {
    // Trascina il pannello
    let pos = menuPanel.object3D.position;
    menuPanel.object3D.position.set(pos.x + deltaX, pos.y - deltaY, pos.z);
  } else {
    // Scroll verticale del menu
    let pos = buttonContainer.object3D.position;
    let newY = pos.y - deltaY;
    newY = Math.min(Math.max(newY, -0.5), 0.5); // Limita lo scroll
    buttonContainer.object3D.position.set(pos.x, newY, pos.z);
  }

  prevPosition = { x: e.touches[0].clientX, y: e.touches[0].clientY };
}, { passive: false });

// Chiudi panel dettaglio e torna al menu
closeBtn.addEventListener('click', () => {
  detailPanel.setAttribute('visible', false);
  menuPanel.setAttribute('visible', true);
});
</script>
</body>
</html>
