<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Menu AR Fix Interazioni</title>
    <script src="https://cdn.jsdelivr.net/npm/aframe@1.4.2/dist/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
    <style>
        #debug {
            position: fixed;
            top: 10px;
            left: 10px;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 10px;
            font-family: monospace;
            z-index: 10000;
        }
        .menu-btn {
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div id="debug">Stato: Inizializzazione...</div>

    <a-scene 
        embedded 
        arjs="sourceType: webcam; debugUIEnabled: false;"
        cursor="rayOrigin: mouse"
        raycaster="objects: .clickable"
    >
        <!-- Marker Hiro -->
        <a-marker preset="hiro" id="marker">
            <!-- Menu Principale -->
            <a-entity id="menu" position="0 1.5 0">
                <!-- Pulsante 1 -->
                <a-entity class="menu-btn clickable" 
                         position="-0.5 0.2 0.1"
                         data-panel="info"
                         onclick="showPanel('info')">
                    <a-box color="#4CC3D9" width="0.8" height="0.3" depth="0.05"></a-box>
                    <a-text value="INFO" color="white" align="center" position="0 0 0.06"></a-text>
                </a-entity>
            </a-entity>

            <!-- Pannello Info -->
            <a-entity id="info-panel" visible="false" position="0 1.5 0.2">
                <a-text value="PANNELLO INFO" color="white" position="0 0.3 0"></a-text>
                <a-entity class="menu-btn clickable" 
                         position="0 -0.3 0.1"
                         onclick="showPanel('main')">
                    <a-box color="red" width="0.8" height="0.3" depth="0.05"></a-box>
                    <a-text value="INDIETRO" color="white" align="center" position="0 0 0.06"></a-text>
                </a-entity>
            </a-entity>
        </a-marker>

        <!-- Camera -->
        <a-entity camera></a-entity>
    </a-scene>

    <script>
        // DEBUG INTEGRATO
        const debug = document.getElementById('debug');
        let markerVisible = false;

        // CONTROLLO MARKER
        document.querySelector('#marker').addEventListener('markerFound', () => {
            markerVisible = true;
            debug.textContent += '\nMarker rilevato';
        });

        document.querySelector('#marker').addEventListener('markerLost', () => {
            markerVisible = false;
            debug.textContent += '\nMarker perso';
        });

        // GESTIONE PULSANTI
        function showPanel(panelName) {
            if(!markerVisible) {
                debug.textContent += '\nTentativo interazione senza marker';
                return;
            }

            debug.textContent += `\nMostro pannello: ${panelName}`;
            
            // Nascondi tutti i pannelli
            document.querySelectorAll('[id$="-panel"]').forEach(p => {
                p.setAttribute('visible', 'false');
            });

            // Mostra il pannello richiesto
            if(panelName === 'main') {
                document.getElementById('menu').setAttribute('visible', 'true');
            } else {
                document.getElementById('menu').setAttribute('visible', 'false');
                document.getElementById(`${panelName}-panel`).setAttribute('visible', 'true');
            }

            // Animazione click
            const btn = event.target.closest('.menu-btn');
            if(btn) {
                btn.setAttribute('scale', '0.9 0.9 0.9');
                setTimeout(() => btn.setAttribute('scale', '1 1 1'), 200);
            }
        }

        // INIZIALIZZAZIONE
        document.addEventListener('DOMContentLoaded', () => {
            debug.textContent += '\nSistema pronto';
            
            // Verifica componenti
            if(!AFRAME.components['cursor']) {
                debug.textContent += '\nERRORE: Componente cursor non trovato';
            }
            if(!AFRAME.components['raycaster']) {
                debug.textContent += '\nERRORE: Componente raycaster non trovato';
            }

            // Forza refresh raycaster
            const scene = document.querySelector('a-scene');
            if(scene) {
                scene.components.raycaster.refreshObjects();
                debug.textContent += '\nRaycaster aggiornato';
            }
        });

        // FIX PER MOBILE
        document.querySelectorAll('.menu-btn').forEach(btn => {
            btn.addEventListener('touchstart', (e) => {
                e.preventDefault();
                btn.setAttribute('scale', '0.95 0.95 0.95');
                debug.textContent += '\nTouch start su pulsante';
            });

            btn.addEventListener('touchend', (e) => {
                e.preventDefault();
                btn.setAttribute('scale', '1 1 1');
                const panel = btn.getAttribute('data-panel') || btn.onclick.toString().match(/showPanel\('(\w+)'/)[1];
                showPanel(panel);
                debug.textContent += '\nTouch end su pulsante';
            });
        });
    </script>
</body>
</html>
