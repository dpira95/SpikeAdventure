<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Pulsante AR Persistente</title>
    <script src="https://cdn.jsdelivr.net/npm/aframe@1.4.2/dist/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
    <style>
        body { margin: 0; overflow: hidden; }
        #status {
            position: absolute;
            top: 30px;
            left: 30px;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 0px;
            font-family: Arial;
            z-index: 1000;
        }
    </style>
</head>
<body>
    <div id="status">Inquadra il marker Hiro</div>

    <a-scene embedded arjs="sourceType: webcam; debugUIEnabled: false;">
        <!-- Marker Hiro -->
        <a-marker preset="hiro" id="marker" emitevents="true"></a-marker>
        
        <!-- Pulsante 3D (aggiunto dinamicamente) -->
        <a-entity id="button-container"></a-entity>

        <!-- Camera con raycaster ottimizzato per mobile/desktop -->
        <a-entity camera>
            <a-entity cursor="rayOrigin: mouse"
                     raycaster="far: 1000; objects: .clickable"></a-entity>
        </a-entity>
    </a-scene>

    <script>
        // VARIABILI GLOBALI
        let buttonCreated = false;
        const statusDiv = document.getElementById('status');
        const container = document.getElementById('button-container');
        const scene = document.querySelector('a-scene');

        // CREAZIONE PULSANTE
        function createButton() {
            if(buttonCreated) return;
            
            container.innerHTML = `
                <a-box id="my-button" 
                      position="0 0 0" 
                      width="1" 
                      height="0.3" 
                      depth="0.1"
                      color="#4CC3D9"
                      class="clickable"
                      event-set__enter="scale: 1.2 1.2 1.2"
                      event-set__leave="scale: 1 1 1">
                    <a-text value="CLICCAMI" 
                           align="center" 
                           position="0 0 0.1" 
                           color="white"></a-text>
                </a-box>
                
                <a-box id="red-rect"
                      position="0 -0.5 0"
                      width="1.5"
                      height="0.5"
                      depth="0.1"
                      color="red"
                      visible="false"></a-box>
            `;
            
            buttonCreated = true;
            statusDiv.textContent = "Pulsante creato - Toccalo!";
            
            // Aggiungi event listeners manualmente
            const button = document.getElementById('my-button');
            const rect = document.getElementById('red-rect');
            
            // Gestione click desktop
            button.addEventListener('click', () => {
                rect.setAttribute('visible', !rect.getAttribute('visible'));
            });
            
            // Gestione touch mobile
            button.addEventListener('touchstart', (e) => {
                e.preventDefault();
                button.setAttribute('scale', '1.2 1.2 1.2');
            });
            
            button.addEventListener('touchend', (e) => {
                e.preventDefault();
                button.setAttribute('scale', '1 1 1');
                rect.setAttribute('visible', !rect.getAttribute('visible'));
                statusDiv.textContent = "Toccato! Rettangolo " + 
                    (rect.getAttribute('visible') ? "visibile" : "nascosto");
            });
        }

        // GESTIONE MARKER
        document.getElementById('marker').addEventListener('markerFound', (e) => {
            if(!buttonCreated) {
                // Posiziona il container dove Ã¨ stato trovato il marker
                const markerPos = e.target.object3D.position;
                container.setAttribute('position', markerPos);
                container.setAttribute('visible', 'true');
                
                createButton();
            }
        });

        // FORZA AGGIORNAMENTO RAYCASTER (fix per mobile)
        setTimeout(() => {
            if(scene.components.raycaster) {
                scene.components.raycaster.refreshObjects();
            }
        }, 2000);
    </script>
</body>
</html>
