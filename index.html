<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Pulsante AR Full Interactivity</title>
    <script src="https://cdn.jsdelivr.net/npm/aframe@1.4.2/dist/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
    <style>
        body { margin: 0; overflow: hidden; }
        #status {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 10px;
            font-family: Arial;
            z-index: 1000;
        }
    </style>
</head>
<body>
    <div id="status">Inquadra il marker Hiro</div>

    <a-scene 
        embedded 
        arjs="sourceType: webcam; debugUIEnabled: false;"
        renderer="logarithmicDepthBuffer: true;"
    >
        <!-- Marker Hiro -->
        <a-marker preset="hiro" id="marker" emitevents="true">
            <!-- Area interattiva invisibile (genera il collider) -->
            <a-entity id="button-hitbox"
                class="clickable"
                geometry="primitive: box; width: 1.2; height: 0.5; depth: 0.2"
                material="visible: false"
                position="0 1.5 0"
                event-set__mouseenter="scale: 1.1 1.1 1.1"
                event-set__mouseleave="scale: 1 1 1"
                event-set__mousedown="scale: 0.9 0.9 0.9"
                event-set__mouseup="scale: 1 1 1">
            </a-entity>

            <!-- Pulsante visibile (estetico) -->
            <a-box id="button-visual"
                position="0 1.5 0"
                width="1"
                height="0.3"
                depth="0.1"
                color="#4CC3D9">
                <a-text value="CLICCAMI" 
                    align="center" 
                    position="0 0 0.1" 
                    color="white"></a-text>
            </a-box>

            <!-- Feedback visivo -->
            <a-box id="red-rect"
                position="0 1 0"
                width="1.5"
                height="0.5"
                depth="0.1"
                color="red"
                visible="false"></a-box>
        </a-marker>

        <!-- Camera con raycaster ottimizzato -->
        <a-entity camera>
            <a-entity cursor="rayOrigin: mouse; fuse: false"
                     raycaster="far: 100; interval: 10; objects: .clickable"></a-entity>
        </a-entity>
    </a-scene>

    <script>
        // 1. INIZIALIZZAZIONE
        const statusDiv = document.getElementById('status');
        const hitbox = document.getElementById('button-hitbox');
        const visual = document.getElementById('button-visual');
        const redRect = document.getElementById('red-rect');
        let buttonActive = false;

        // 2. OTTIMIZZAZIONE RAYCASTER
        function refreshRaycaster() {
            const scene = document.querySelector('a-scene');
            if(scene && scene.components.raycaster) {
                scene.components.raycaster.refreshObjects();
                console.log("Raycaster aggiornato");
            }
        }

        // 3. GESTIONE INTERAZIONI
        function setupInteractions() {
            // Desktop
            hitbox.addEventListener('click', () => {
                if(!buttonActive) return;
                toggleRedRect();
            });

            // Mobile
            hitbox.addEventListener('touchstart', (e) => {
                e.preventDefault();
                if(!buttonActive) return;
                hitbox.setAttribute('scale', '0.9 0.9 0.9');
            });

            hitbox.addEventListener('touchend', (e) => {
                e.preventDefault();
                hitbox.setAttribute('scale', '1 1 1');
                if(buttonActive) toggleRedRect();
            });
        }

        // 4. TOGGLE FEEDBACK VISIVO
        function toggleRedRect() {
            const visible = redRect.getAttribute('visible');
            redRect.setAttribute('visible', !visible);
            statusDiv.textContent = !visible ? 
                "Pulsante attivato!" : "Pronto per un nuovo click";
        }

        // 5. GESTIONE MARKER
        document.getElementById('marker').addEventListener('markerFound', () => {
            buttonActive = true;
            statusDiv.textContent = "Pulsante pronto - Interagisci!";
            
            // Sincronizza posizione hitbox e visual
            const markerPos = document.getElementById('marker').object3D.position;
            hitbox.setAttribute('position', markerPos);
            visual.setAttribute('position', markerPos);
            redRect.setAttribute('position', {
                x: markerPos.x,
                y: markerPos.y - 0.5,
                z: markerPos.z
            });
        });

        document.getElementById('marker').addEventListener('markerLost', () => {
            buttonActive = false;
        });

        // 6. AVVIO
        window.addEventListener('load', () => {
            setupInteractions();
            
            // Fix per mobile
            setTimeout(refreshRaycaster, 1500);
            setInterval(refreshRaycaster, 3000);
            
            // Debug
            console.log("Sistema pronto");
            statusDiv.textContent += " - Attendere inizializzazione...";
        });
    </script>
</body>
</html>
