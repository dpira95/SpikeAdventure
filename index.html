<!DOCTYPE html>
<html>
<head>
  <title>AR.js - Menu AR Scrollabile e Tocco Diretto</title>
  <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
  <script src="https://raw.githack.com/AR-js-org/AR.js/3.4.5/aframe/build/aframe-ar.js"></script>

  <style>
    body {
      margin: 0;
      overflow: hidden;
    }
  </style>
</head>

<body>
  <a-scene embedded arjs vr-mode-ui="enabled: false">
    <a-marker preset="hiro" id="hiroMarker"></a-marker>

    <!-- Pannello menu principale -->
    <a-plane id="menuPanel"
      position="0 0 -2"
      rotation="-45 0 0"
      width="1" height="1.8"
      color="#222" opacity="0.8" visible="false">

      <!-- Rettangolo del titolo (per spostare il menu) -->
      <a-plane id="titleBar"
        position="0 0.75 0.02"
        width="1" height="0.2"
        color="#333" opacity="0.8">
        <a-text value="Menu" color="#FFF" align="center" width="1.2" scale="0.5 0.5 0.5" position="0 0 0.02"></a-text>
      </a-plane>

      <!-- Container scorrevole -->
      <a-entity id="buttonContainer" position="0 0.3 0.02">
        <!-- Pulsanti con spaziatura e testo ridimensionato -->
        <a-plane class="menu-button" data-info="Pizza Classica" data-description="La classica pizza margherita con pomodoro, mozzarella e basilico." width="0.9" height="0.18" color="#FF4444" position="0 0.6 0.01">
          <a-text value="Pizza Margherita" align="center" color="#FFF" scale="0.5 0.5 0.5" position="0 0 0.02"></a-text>
        </a-plane>
        <a-plane class="menu-button" data-info="Lasagna" data-description="Lasagna al forno con ragù, besciamella e formaggio." width="0.9" height="0.18" color="#44AAFF" position="0 0.35 0.01">
          <a-text value="Lasagna" align="center" color="#FFF" scale="0.5 0.5 0.5" position="0 0 0.02"></a-text>
        </a-plane>
        <a-plane class="menu-button" data-info="Carbonara" data-description="Spaghetti alla carbonara con uova, guanciale e pecorino." width="0.9" height="0.18" color="#44FF88" position="0 0.1 0.01">
          <a-text value="Carbonara" align="center" color="#FFF" scale="0.5 0.5 0.5" position="0 0 0.02"></a-text>
        </a-plane>
        <a-plane class="menu-button" data-info="Insalata Greca" data-description="Insalata greca con pomodori, cetrioli, olive e feta." width="0.9" height="0.18" color="#FFAA44" position="0 -0.15 0.01">
          <a-text value="Insalata Greca" align="center" color="#FFF" scale="0.5 0.5 0.5" position="0 0 0.02"></a-text>
        </a-plane>
        <a-plane class="menu-button" data-info="Tiramisù" data-description="Il classico tiramisù con savoiardi, caffè e mascarpone." width="0.9" height="0.18" color="#AA44FF" position="0 -0.4 0.01">
          <a-text value="Tiramisù" align="center" color="#FFF" scale="0.5 0.5 0.5" position="0 0 0.02"></a-text>
        </a-plane>
        <a-plane class="menu-button" data-info="Filetto al Pepe" data-description="Filetto di manzo al pepe con salsa cremosa." width="0.9" height="0.18" color="#FF4488" position="0 -0.65 0.01">
          <a-text value="Filetto al Pepe" align="center" color="#FFF" scale="0.5 0.5 0.5" position="0 0 0.02"></a-text>
        </a-plane>
      </a-entity>
    </a-plane>

    <!-- Pannello di dettaglio (inizialmente nascosto) -->
    <a-plane id="detailPanel"
      position="0 0 -2"
      rotation="-45 0 0"
      width="1" height="1.8"
      color="#222" opacity="0.8" visible="false">

      <!-- Titolo del piatto -->
      <a-text id="detailTitle" value="" color="#FFF" align="center" width="1.2" scale="0.5 0.5 0.5" position="0 0.75 0.02"></a-text>

      <!-- Descrizione del piatto -->
      <a-text id="detailDescription" value="" color="#FFF" align="center" width="0.9" scale="0.4 0.4 0.4" position="0 0.3 0.02" wrap-count="20"></a-text>

      <!-- Pulsante per tornare al menu principale -->
      <a-plane id="backButton"
        position="0 -0.7 0.02"
        width="0.6" height="0.18"
        color="#333" opacity="0.8">
        <a-text value="Torna al Menu" align="center" color="#FFF" scale="0.4 0.4 0.4" position="0 0 0.02"></a-text>
      </a-plane>
    </a-plane>

    <!-- Camera con cursore invisibile e senza delay -->
    <a-entity camera>
      <a-cursor id="cursor"
                rayOrigin="mouse"
                fuse="false"
                material="opacity: 0;"
                position="0 0 -1">
      </a-cursor>
    </a-entity>
  </a-scene>

<script>
const marker = document.querySelector("#hiroMarker");
const menuPanel = document.querySelector("#menuPanel");
const buttonContainer = document.querySelector("#buttonContainer");
const buttons = document.querySelectorAll('.menu-button');
const cursor = document.querySelector("#cursor");
const titleBar = document.querySelector("#titleBar");
const detailPanel = document.querySelector("#detailPanel");
const detailTitle = document.querySelector("#detailTitle");
const detailDescription = document.querySelector("#detailDescription");
const backButton = document.querySelector("#backButton");

// Variabili per gestire lo scroll touch e lo spostamento del menu
let startY = null;
let isScrolling = false;
let isDraggingMenu = false;
let menuStartPosition = { x: 0, y: 0, z: -2 };

// Mostra il menu quando il marker è rilevato
marker.addEventListener("markerFound", () => {
  menuPanel.setAttribute("visible", "true");
});

// Il menu rimane visibile anche se il marker è perso
marker.addEventListener("markerLost", () => {
  // Non fare nulla: il menu rimane visibile
});

// Gestione dello scroll touch
buttonContainer.addEventListener('touchstart', e => {
  startY = e.touches[0].clientY;
  isScrolling = true;
});

buttonContainer.addEventListener('touchmove', e => {
  if (!isScrolling) return;

  let deltaY = (e.touches[0].clientY - startY) * 0.003;
  let pos = buttonContainer.object3D.position;
  pos.y = Math.min(Math.max(pos.y + deltaY, -0.8), 1.0); // Limita lo scroll
  startY = e.touches[0].clientY;
});

buttonContainer.addEventListener('touchend', () => {
  isScrolling = false;
});

// Gestione del tocco prolungato per spostare il menu
titleBar.addEventListener('touchstart', e => {
  isDraggingMenu = true;
  menuStartPosition = menuPanel.object3D.position.clone(); // Salva la posizione iniziale
});

titleBar.addEventListener('touchmove', e => {
  if (!isDraggingMenu) return;

  const touch = e.touches[0];
  const camera = document.querySelector("[camera]").object3D;
  const worldPosition = new THREE.Vector3();

  // Converti le coordinate del touch in coordinate 3D
  worldPosition.set(
    (touch.clientX / window.innerWidth) * 2 - 1,
    -(touch.clientY / window.innerHeight) * 2 + 1,
    0.5
  ).unproject(camera);

  // Aggiorna la posizione del menu
  menuPanel.object3D.position.set(worldPosition.x, worldPosition.y, worldPosition.z);
  detailPanel.object3D.position.set(worldPosition.x, worldPosition.y, worldPosition.z); // Sposta anche il pannello di dettaglio
});

titleBar.addEventListener('touchend', () => {
  isDraggingMenu = false;
});

// Aggiorna la posizione del cursore in base al touch
window.addEventListener('touchstart', e => {
  const touch = e.touches[0];
  cursor.object3D.position.set(touch.clientX / window.innerWidth * 2 - 1, -(touch.clientY / window.innerHeight * 2 - 1), -1);
});

window.addEventListener('touchmove', e => {
  const touch = e.touches[0];
  cursor.object3D.position.set(touch.clientX / window.innerWidth * 2 - 1, -(touch.clientY / window.innerHeight * 2 - 1), -1);
});

// Interazione con i pulsanti (selezione al rilascio del tocco)
buttons.forEach(btn => {
  btn.addEventListener('touchend', () => {
    const dish = btn.getAttribute('data-info');
    const description = btn.getAttribute('data-description');

    // Nascondi il menu principale e mostra il pannello di dettaglio
    menuPanel.setAttribute("visible", "false");
    detailPanel.setAttribute("visible", "true");

    // Imposta il titolo e la descrizione nel pannello di dettaglio
    detailTitle.setAttribute("value", dish);
    detailDescription.setAttribute("value", description);
  });
});

// Pulsante per tornare al menu principale
backButton.addEventListener('touchend', () => {
  detailPanel.setAttribute("visible", "false");
  menuPanel
