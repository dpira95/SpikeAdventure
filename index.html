<!DOCTYPE html>
<html>
<head>
  <title>AR.js con Rettangolo Spostabile</title>
  <!-- Libreria A-Frame -->
  <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
  <!-- Libreria AR.js -->
  <script src="https://raw.githack.com/AR-js-org/AR.js/3.4.5/aframe/build/aframe-ar.js"></script>

  <style>
    .message {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      padding: 12px 18px;
      background-color: rgba(0,0,0,0.5);
      color: white;
      font-family: Arial, sans-serif;
      border-radius: 10px;
      z-index: 9999;
      user-select: none;
    }
  </style>
</head>

<body style="margin: 0; overflow: hidden;">
  <div id="info" class="message">Inquadra il marker...</div>

  <a-scene embedded arjs>
    <!-- Marker Hiro -->
    <a-marker preset="hiro" id="hiroMarker"></a-marker>

    <!-- Rettangolo indipendente ancorato alla telecamera -->
    <a-plane 
      id="draggableRect" 
      position="0 0 -2"
      rotation="-45 0 0" 
      width="0.5" height="1" 
      color="#7BC8A4"
      visible="false"
      cursor-listener>
    </a-plane>

    <!-- Camera -->
    <a-entity camera look-controls>
      <a-entity cursor="fuse: false; rayOrigin: mouse;"></a-entity>
    </a-entity>
  </a-scene>

  <script>
const marker = document.querySelector("#hiroMarker");
const info = document.getElementById("info");
const rect = document.querySelector("#draggableRect");
let isDragging = false;
let previousMousePosition = { x: 0, y: 0 };

marker.addEventListener("markerFound", () => {
  info.innerText = "Marker rilevato!";
  rect.setAttribute("visible", "true");
});

marker.addEventListener("markerLost", () => {
  info.innerText = "Marker perso, puoi spostare il rettangolo.";
});

// Mouse events (desktop)
rect.addEventListener('mousedown', (e) => {
  isDragging = true;
  previousMousePosition = { x: e.clientX, y: e.clientY };
});

window.addEventListener('mouseup', () => {
  isDragging = false;
});

window.addEventListener('mousemove', (e) => {
  if (!isDragging) return;

  let deltaX = (e.clientX - previousMousePosition.x) / 250;
  let deltaY = (e.clientY - previousMousePosition.y) / 250;

  let position = rect.getAttribute('position');
  rect.setAttribute('position', {
    x: position.x + deltaX,
    y: position.y - deltaY,
    z: position.z
  });

  previousMousePosition = { x: e.clientX, y: e.clientY };
});

// Touch events (mobile)
rect.addEventListener('touchstart', (e) => {
  if (e.touches.length == 1) {
    isDragging = true;
    previousMousePosition = {
      x: e.touches[0].clientX,
      y: e.touches[0].clientY
    };
  }
});

window.addEventListener('touchend', () => {
  isDragging = false;
});

window.addEventListener('touchmove', (e) => {
  if (!isDragging || e.touches.length != 1) return;

  e.preventDefault();

  let deltaX = (e.touches[0].clientX - previousMousePosition.x) / 250;
  let deltaY = (e.touches[0].clientY - previousMousePosition.y) / 250;

  let position = rect.getAttribute('position');
  rect.setAttribute('position', {
    x: position.x + deltaX,
    y: position.y - deltaY,
    z: position.z
  });

  previousMousePosition = {
    x: e.touches[0].clientX,
    y: e.touches[0].clientY
  };
}, { passive: false });
</script>

</body>
</html>
